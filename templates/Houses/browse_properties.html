{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="browse-container">
    <div class="browse-header">
        <h1>Browse Properties</h1>
        <p>Find your perfect home from {{ total_count }} available properties</p>
    </div>
    
    <!-- Filters Section -->
    <div class="filters-section">
        <h3>Filter Properties</h3>
        <form method="get" class="filters-form">
            <div class="filter-group">
                <label for="category">Category</label>
                <select id="category" name="category">
                    <option value="">All Categories</option>
                    {% for value, label in categories %}
                        <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group" style="position: relative;">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" value="{{ selected_location }}" placeholder="e.g., Westlands, Nairobi" autocomplete="off">
                <div id="locationDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 0.25rem;"></div>
            </div>
            
            <div class="filter-group">
                <label for="rooms">Rooms</label>
                <select id="rooms" name="rooms">
                    <option value="">Any</option>
                    {% for i in "123456789" %}
                        <option value="{{ i }}" {% if selected_rooms == i %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                    <option value="10" {% if selected_rooms == "10" %}selected{% endif %}>10+</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="min_price">Min Price (KSh)</label>
                <input type="number" id="min_price" name="min_price" value="{{ min_price }}" placeholder="0">
            </div>
            
            <div class="filter-group">
                <label for="max_price">Max Price (KSh)</label>
                <input type="number" id="max_price" name="max_price" value="{{ max_price }}" placeholder="100000">
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="{% url 'browse_properties' %}" class="btn btn-secondary">Clear</a>
            </div>
        </form>
    </div>
    
    <!-- Properties Grid -->
    {% if properties %}
        <div class="properties-grid">
            {% for property in properties %}
            <div class="property-card">
                <a href="{% url 'property_detail' property.pk %}" class="property-link">
                    {% if property.images.first %}
                        <img src="{{ property.images.first.image.url }}" alt="{{ property.title }}" class="property-image">
                    {% else %}
                        <div class="no-image">No Image</div>
                    {% endif %}
                    
                    <div class="property-details">
                        <div class="property-header">
                            <h4>{{ property.title }}</h4>
                            <span class="status available">Available</span>
                        </div>
                        
                        <p class="category">{{ property.get_category_display }}</p>
                        
                        <div class="property-info-grid">
                            <div class="info-item">
                                <span class="label">Price:</span>
                                <span class="value">KSh {{ property.price }}/month</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Location:</span>
                                <span class="value">{{ property.location }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Rooms:</span>
                                <span class="value">{{ property.number_of_rooms }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Units:</span>
                                <span class="value">{{ property.available_units }} / {{ property.total_units }}</span>
                            </div>
                        </div>
                        
                        {% if property.amenities %}
                        <div class="amenities-list">
                            <div class="amenity-tags">
                                {% for amenity in property.get_amenities_list|slice:":3" %}
                                    <span class="tag">{{ amenity }}</span>
                                {% endfor %}
                                {% if property.get_amenities_list|length > 3 %}
                                    <span class="tag more">+{{ property.get_amenities_list|length|add:"-3" }} more</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <p class="description">{{ property.description|truncatewords:15 }}</p>
                        
                        <div class="property-actions">
                            <span class="btn btn-primary btn-small">View & Book</span>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h3>No Properties Found</h3>
            <p>Try adjusting your filters to find more properties.</p>
            <a href="{% url 'browse_properties' %}" class="btn btn-primary">Clear Filters</a>
        </div>
    {% endif %}
</div>

<style>
.browse-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 2rem;
}

.browse-header {
    text-align: center;
    margin-bottom: 2rem;
}

.browse-header h1 {
    color: #333;
    margin-bottom: 0.5rem;
}

.browse-header p {
    color: #666;
    font-size: 1.1rem;
}

.filters-section {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.filters-section h3 {
    margin-top: 0;
    color: #667eea;
    margin-bottom: 1.5rem;
}

.filters-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    margin-bottom: 0.5rem;
    color: #333;
    font-weight: 500;
    font-size: 0.9rem;
}

.filter-group input,
.filter-group select {
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.filter-group input:focus,
.filter-group select:focus {
    outline: none;
    border-color: #667eea;
}

.filter-actions {
    display: flex;
    gap: 0.5rem;
    grid-column: 1 / -1;
    justify-content: center;
    margin-top: 1rem;
}

.properties-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
}

.property-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s;
}

.property-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.property-link {
    text-decoration: none;
    color: inherit;
    display: block;
}

.property-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
}

.no-image {
    width: 100%;
    height: 200px;
    background: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
}

.property-details {
    padding: 1.5rem;
}

.property-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
}

.property-header h4 {
    margin: 0;
    color: #333;
    flex: 1;
    font-size: 1.1rem;
}

.status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
    margin-left: 0.5rem;
}

.status.available {
    background: #d4edda;
    color: #155724;
}

.category {
    display: inline-block;
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-bottom: 1rem;
}

.property-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.info-item {
    display: flex;
    flex-direction: column;
}

.info-item .label {
    font-size: 0.8rem;
    color: #666;
    font-weight: 600;
}

.info-item .value {
    font-size: 0.9rem;
    color: #333;
}

.amenities-list {
    margin-bottom: 1rem;
}

.amenity-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.tag {
    background: #e8eaf6;
    color: #3f51b5;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.75rem;
}

.tag.more {
    background: #f0f0f0;
    color: #666;
}

.description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    line-height: 1.4;
}

.property-actions {
    text-align: center;
}

.btn-small {
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
    display: inline-block;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.empty-state h3 {
    color: #667eea;
    margin-bottom: 1rem;
}

.empty-state p {
    color: #666;
    margin-bottom: 2rem;
}

@media (max-width: 768px) {
    .filters-form {
        grid-template-columns: 1fr;
    }
    
    .properties-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script>
document.addEventListener('DOMContentLoaded', function() {
    const locationInput = document.getElementById('location');
    const dropdown = document.getElementById('locationDropdown');
    let searchTimeout;
    
    if (locationInput && dropdown) {
        // Autocomplete as user types
        locationInput.addEventListener('input', function(e) {
            const query = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                autocompleteLocation(query);
            }, 300);
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!locationInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    }
    
    function autocompleteLocation(query) {
        const locationiqToken = 'YOUR_LOCATIONIQ_TOKEN_HERE';  // Get free token from https://locationiq.com
        const url = `https://us1.locationiq.com/v1/autocomplete.php?key=${locationiqToken}&q=${encodeURIComponent(query)}&limit=8&countrycodes=ke&format=json`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    dropdown.innerHTML = '';
                    data.forEach(item => {
                        const option = document.createElement('div');
                        option.style.padding = '0.75rem 1rem';
                        option.style.cursor = 'pointer';
                        option.style.borderBottom = '1px solid #f0f0f0';
                        option.style.transition = 'background 0.2s';
                        option.textContent = item.display_name;
                        
                        option.addEventListener('mouseenter', function() {
                            this.style.background = '#f8f9ff';
                        });
                        
                        option.addEventListener('mouseleave', function() {
                            this.style.background = 'white';
                        });
                        
                        option.addEventListener('click', function() {
                            locationInput.value = item.display_name;
                            dropdown.style.display = 'none';
                        });
                        
                        dropdown.appendChild(option);
                    });
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Autocomplete error:', error);
                dropdown.style.display = 'none';
            });
    }
});
</script>
{% endblock %}
